<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MIDI Voicing Lab</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>
<body>
  <main class="app-shell">
    <section class="panel">
      <h1>MIDI Voicing Lab</h1>
      <p>
        Gib eine Akkordfolge ein, wähle einen Stil und exportiere eine MIDI-Datei für Logic Pro.
        Die Engine nutzt Voice-Leading, 2-5-1-Erkennung und modale Farbwechsel.
      </p>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <ul class="alerts">
            {% for category, message in messages %}
              <li class="alert {{ category }}">{{ message }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}

      <form action="{{ url_for('generate') }}" method="post" id="generator-form">
        <label for="progression">Akkordfolge</label>
        <textarea id="progression" name="progression" rows="4" required>Dm7 G7 Cmaj7 A7 | Dm7 G7 Cmaj7</textarea>

        <div class="row">
          <div>
            <label for="style">Style</label>
            <select id="style" name="style">
              <option value="random">Random</option>
              {% for key, profile in styles.items() %}
                <option value="{{ key }}">{{ profile.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label for="tempo">Tempo (BPM)</label>
            <input id="tempo" name="tempo" type="number" min="40" max="220" value="98" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="complexity">Komplexität: <span id="complexity-value">65</span></label>
            <input id="complexity" name="complexity" type="range" min="0" max="100" value="65" />
          </div>

          <div>
            <label for="beats_per_chord">Beats pro Akkord</label>
            <select id="beats_per_chord" name="beats_per_chord">
              <option value="4">4 (ganzer Takt)</option>
              <option value="2">2 (halber Takt)</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="variations">Varianten (Batch)</label>
            <input id="variations" name="variations" type="number" min="1" max="12" value="1" />
          </div>
        </div>

        <div class="row">
          <div>
            <label class="toggle">
              <input id="humanize" name="humanize" type="checkbox" checked />
              Humanize aktivieren
            </label>
          </div>
          <div>
            <label for="humanize_amount">Humanize Stärke: <span id="humanize-value">30</span></label>
            <input id="humanize_amount" name="humanize_amount" type="range" min="0" max="100" value="30" />
          </div>
        </div>

        <input type="hidden" id="seed" name="seed" value="" />

        <div class="actions">
          <button type="button" id="randomize">Zufall</button>
          <button type="submit">MIDI / ZIP generieren</button>
        </div>
      </form>
    </section>

    <section class="panel hint-panel">
      <h2>Input-Beispiele</h2>
      <ul>
        {% for progression in samples %}
          <li><button type="button" class="sample" data-progression="{{ progression }}">{{ progression }}</button></li>
        {% endfor %}
      </ul>
      <p class="hint">Tipp: Mit höherer Komplexität werden mehr Alterationen, Spannungsnoten und modale Farben genutzt.</p>
    </section>
  </main>

  <script>
    const complexityInput = document.getElementById('complexity');
    const complexityValue = document.getElementById('complexity-value');
    const styleSelect = document.getElementById('style');
    const progressionInput = document.getElementById('progression');
    const tempoInput = document.getElementById('tempo');
    const variationsInput = document.getElementById('variations');
    const humanizeCheckbox = document.getElementById('humanize');
    const humanizeInput = document.getElementById('humanize_amount');
    const humanizeValue = document.getElementById('humanize-value');
    const seedInput = document.getElementById('seed');

    complexityInput.addEventListener('input', () => {
      complexityValue.textContent = complexityInput.value;
    });
    humanizeInput.addEventListener('input', () => {
      humanizeValue.textContent = humanizeInput.value;
    });

    const sampleButtons = [...document.querySelectorAll('.sample')];
    sampleButtons.forEach((button) => {
      button.addEventListener('click', () => {
        progressionInput.value = button.dataset.progression;
      });
    });

    document.getElementById('randomize').addEventListener('click', () => {
      const styleOptions = [...styleSelect.options].filter((option) => option.value !== 'random');
      const stylePick = styleOptions[Math.floor(Math.random() * styleOptions.length)];
      styleSelect.value = stylePick.value;

      if (sampleButtons.length > 0) {
        const samplePick = sampleButtons[Math.floor(Math.random() * sampleButtons.length)];
        progressionInput.value = samplePick.dataset.progression;
      }

      complexityInput.value = String(40 + Math.floor(Math.random() * 61));
      complexityValue.textContent = complexityInput.value;
      tempoInput.value = String(82 + Math.floor(Math.random() * 56));
      variationsInput.value = String(1 + Math.floor(Math.random() * 4));
      humanizeCheckbox.checked = Math.random() > 0.15;
      humanizeInput.value = String(18 + Math.floor(Math.random() * 50));
      humanizeValue.textContent = humanizeInput.value;
      seedInput.value = String(Math.floor(Math.random() * 1000000000));
    });
  </script>
</body>
</html>
