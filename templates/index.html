<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MIDI Voicing Lab</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>
<body>
  <main class="app-shell">
    <section class="panel">
      <h1>MIDI Voicing Lab</h1>
      <p>
        Gib eine Akkordfolge ein, wähle einen Stil und exportiere eine MIDI-Datei für Logic Pro.
        Die Engine nutzt Voice-Leading, 2-5-1-Erkennung und modale Farbwechsel.
      </p>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <ul class="alerts">
            {% for category, message in messages %}
              <li class="alert {{ category }}">{{ message }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}

      <form action="{{ url_for('generate') }}" method="post" id="generator-form" data-preview-url="{{ url_for('preview') }}">
        <label for="progression">Akkordfolge</label>
        <textarea id="progression" name="progression" rows="4" required>Dm7 G7 Cmaj7 A7 | Dm7 G7 Cmaj7</textarea>

        <div class="row">
          <div>
            <label for="style">Style</label>
            <select id="style" name="style">
              <option value="random">Random</option>
              {% for key, profile in styles.items() %}
                <option value="{{ key }}">{{ profile.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label for="tempo">Tempo (BPM)</label>
            <input id="tempo" name="tempo" type="number" min="40" max="220" value="98" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="complexity">Komplexität: <span id="complexity-value">65</span></label>
            <input id="complexity" name="complexity" type="range" min="0" max="100" value="65" />
          </div>

          <div>
            <label for="beats_per_chord">Beats pro Akkord</label>
            <select id="beats_per_chord" name="beats_per_chord">
              <option value="4">4 (ganzer Takt)</option>
              <option value="2">2 (halber Takt)</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="variations">Varianten (Batch)</label>
            <input id="variations" name="variations" type="number" min="1" max="12" value="1" />
          </div>
        </div>

        <div class="row">
          <div>
            <label class="toggle">
              <input id="humanize" name="humanize" type="checkbox" checked />
              Humanize aktivieren
            </label>
          </div>
          <div>
            <label for="humanize_amount">Humanize Stärke: <span id="humanize-value">30</span></label>
            <input id="humanize_amount" name="humanize_amount" type="range" min="0" max="100" value="30" />
          </div>
        </div>

        <input type="hidden" id="seed" name="seed" value="" />

        <div class="actions">
          <button type="button" id="preview">Anhören</button>
          <button type="button" id="stop-preview">Stop</button>
          <button type="button" id="randomize">Zufall</button>
          <button type="submit">MIDI / ZIP generieren</button>
        </div>
        <p id="preview-status" class="hint">Preview bereit.</p>
      </form>
    </section>

    <section class="panel hint-panel">
      <h2>Input-Beispiele</h2>
      <ul>
        {% for progression in samples %}
          <li><button type="button" class="sample" data-progression="{{ progression }}">{{ progression }}</button></li>
        {% endfor %}
      </ul>
      <p class="hint">Tipp: Mit höherer Komplexität werden mehr Alterationen, Spannungsnoten und modale Farben genutzt.</p>
    </section>
  </main>

  <script>
    const complexityInput = document.getElementById('complexity');
    const complexityValue = document.getElementById('complexity-value');
    const form = document.getElementById('generator-form');
    const styleSelect = document.getElementById('style');
    const progressionInput = document.getElementById('progression');
    const tempoInput = document.getElementById('tempo');
    const variationsInput = document.getElementById('variations');
    const humanizeCheckbox = document.getElementById('humanize');
    const humanizeInput = document.getElementById('humanize_amount');
    const humanizeValue = document.getElementById('humanize-value');
    const seedInput = document.getElementById('seed');
    const previewButton = document.getElementById('preview');
    const stopButton = document.getElementById('stop-preview');
    const previewStatus = document.getElementById('preview-status');
    const previewUrl = form.dataset.previewUrl;

    let audioContext = null;
    let activeNodes = [];
    let previewTimeoutId = null;

    complexityInput.addEventListener('input', () => {
      complexityValue.textContent = complexityInput.value;
    });
    humanizeInput.addEventListener('input', () => {
      humanizeValue.textContent = humanizeInput.value;
    });

    const sampleButtons = [...document.querySelectorAll('.sample')];
    sampleButtons.forEach((button) => {
      button.addEventListener('click', () => {
        progressionInput.value = button.dataset.progression;
      });
    });

    function ensureSeed() {
      if (!seedInput.value.trim()) {
        seedInput.value = String(Math.floor(Math.random() * 1000000000));
      }
    }

    function midiToFrequency(note) {
      return 440 * Math.pow(2, (note - 69) / 12);
    }

    function stopPreview() {
      if (previewTimeoutId) {
        window.clearTimeout(previewTimeoutId);
        previewTimeoutId = null;
      }
      activeNodes.forEach((node) => {
        try {
          node.gain.cancelScheduledValues(0);
          node.gain.setValueAtTime(0.0001, node.context.currentTime);
          node.osc.stop();
        } catch (error) {
          // ignore stopped nodes
        }
      });
      activeNodes = [];
      previewStatus.textContent = 'Preview gestoppt.';
    }

    function scheduleHand(notes, startTime, durationSeconds, velocity, waveType, gainScale) {
      notes.forEach((midiNote) => {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.type = waveType;
        osc.frequency.setValueAtTime(midiToFrequency(midiNote), startTime);

        const peak = Math.min(0.25, (velocity / 127) * gainScale);
        const attack = 0.012;
        const release = Math.min(0.18, durationSeconds * 0.45);
        const sustainTime = Math.max(startTime + attack + 0.02, startTime + durationSeconds - release);

        gain.gain.setValueAtTime(0.0001, startTime);
        gain.gain.linearRampToValueAtTime(peak, startTime + attack);
        gain.gain.linearRampToValueAtTime(peak * 0.72, sustainTime);
        gain.gain.linearRampToValueAtTime(0.0001, startTime + durationSeconds + 0.03);

        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.start(startTime);
        osc.stop(startTime + durationSeconds + 0.06);
        activeNodes.push({ osc, gain, context: audioContext });
      });
    }

    function playPreview(data) {
      stopPreview();
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }

      const secPerBeat = 60 / data.tempo;
      const startAt = audioContext.currentTime + 0.04;
      let maxEndTime = startAt;

      data.events.forEach((event) => {
        const startTime = startAt + (event.start_beat * secPerBeat);
        const durationSeconds = Math.max(0.06, event.duration * secPerBeat);
        scheduleHand(event.left_hand, startTime, durationSeconds, event.velocity, 'triangle', 0.14);
        scheduleHand(event.right_hand, startTime, durationSeconds, event.velocity, 'sawtooth', 0.11);
        maxEndTime = Math.max(maxEndTime, startTime + durationSeconds);
      });

      const totalSeconds = Math.max(0, maxEndTime - startAt);
      previewStatus.textContent = `Preview läuft (${data.style}, Seed ${data.seed})`;
      previewTimeoutId = window.setTimeout(() => {
        previewStatus.textContent = 'Preview fertig.';
      }, Math.ceil((totalSeconds + 0.1) * 1000));
    }

    previewButton.addEventListener('click', async () => {
      ensureSeed();
      previewButton.disabled = true;
      previewStatus.textContent = 'Preview wird berechnet...';
      try {
        const response = await fetch(previewUrl, {
          method: 'POST',
          body: new FormData(form),
        });
        const payload = await response.json();
        if (!response.ok) {
          throw new Error(payload.error || 'Preview fehlgeschlagen.');
        }
        seedInput.value = String(payload.seed);
        playPreview(payload);
      } catch (error) {
        previewStatus.textContent = `Fehler: ${error.message}`;
      } finally {
        previewButton.disabled = false;
      }
    });

    stopButton.addEventListener('click', () => {
      stopPreview();
    });

    form.addEventListener('submit', () => {
      ensureSeed();
    });

    document.getElementById('randomize').addEventListener('click', () => {
      const styleOptions = [...styleSelect.options].filter((option) => option.value !== 'random');
      const stylePick = styleOptions[Math.floor(Math.random() * styleOptions.length)];
      styleSelect.value = stylePick.value;

      if (sampleButtons.length > 0) {
        const samplePick = sampleButtons[Math.floor(Math.random() * sampleButtons.length)];
        progressionInput.value = samplePick.dataset.progression;
      }

      complexityInput.value = String(40 + Math.floor(Math.random() * 61));
      complexityValue.textContent = complexityInput.value;
      tempoInput.value = String(82 + Math.floor(Math.random() * 56));
      variationsInput.value = String(1 + Math.floor(Math.random() * 4));
      humanizeCheckbox.checked = Math.random() > 0.15;
      humanizeInput.value = String(18 + Math.floor(Math.random() * 50));
      humanizeValue.textContent = humanizeInput.value;
      seedInput.value = String(Math.floor(Math.random() * 1000000000));
      previewStatus.textContent = 'Preview bereit.';
    });
  </script>
</body>
</html>
